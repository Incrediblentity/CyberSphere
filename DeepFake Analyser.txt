import React, { useState } from "react";
import { motion } from "framer-motion";
import { Camera, Upload, Loader2, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { base44 } from "@/api/base44Client";
import ScanResult from "./ScanResult";

export default function DeepFakeAnalyzer() {
  const [image, setImage] = useState(null);
  const [preview, setPreview] = useState(null);
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);

  const handleImageChange = (e) => {
    const selectedFile = e.target.files[0];
    if (selectedFile) {
      setImage(selectedFile);
      setPreview(URL.createObjectURL(selectedFile));
      setResult(null);
    }
  };

  const handleAnalyze = async () => {
    if (!image) return;

    setLoading(true);
    setResult(null);

    try {
      const { file_url } = await base44.integrations.Core.UploadFile({ file: image });

      const analysis = await base44.integrations.Core.InvokeLLM({
        prompt: `Analyze this image for deepfake indicators and manipulation.
        
        Check for:
        - AI-generated content indicators
        - Image manipulation artifacts
        - Face morphing or replacement
        - Inconsistent lighting or shadows
        - Unnatural facial features or expressions
        - Overall authenticity
        
        Provide:
        1. Safety score (0-100, where 100 means completely authentic/real)
        2. Whether it's authentic (true) or likely manipulated/deepfake (false)
        3. Detailed analysis of what you found
        4. List of 3-5 specific indicators or recommendations`,
        file_urls: [file_url],
        response_json_schema: {
          type: "object",
          properties: {
            safety_score: { type: "number" },
            is_safe: { type: "boolean" },
            analysis: { type: "string" },
            recommendations: { type: "array", items: { type: "string" } }
          }
        }
      });

      await base44.entities.ScanRecord.create({
        scan_type: "deepfake",
        input_data: file_url,
        safety_score: analysis.safety_score,
        is_safe: analysis.is_safe,
        analysis: analysis.analysis,
        recommendations: analysis.recommendations
      });

      setResult(analysis);
      window.dispatchEvent(new CustomEvent("scanResult", { 
        detail: analysis.is_safe ? "safe" : "malicious" 
      }));
    } catch (error) {
      console.error("Analysis failed:", error);
    }

    setLoading(false);
  };

  return (
    <Card className="backdrop-blur-xl bg-white/5 border-white/10 p-8 rounded-2xl shadow-2xl">
      <div className="flex items-center gap-3 mb-6">
        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-pink-400 to-pink-600 flex items-center justify-center shadow-lg">
          <Camera className="w-6 h-6 text-white" />
        </div>
        <div>
          <h3 className="text-2xl font-bold text-white">DeepFake Analyzer</h3>
          <p className="text-white/60 text-sm">Detect AI-generated and manipulated images</p>
        </div>
      </div>

      <div className="border-2 border-dashed border-white/20 rounded-xl p-8 mb-4 hover:border-pink-400 transition-colors duration-300">
        <input
          type="file"
          id="image-upload"
          className="hidden"
          onChange={handleImageChange}
          accept="image/*"
        />
        <label htmlFor="image-upload" className="cursor-pointer block text-center">
          {preview ? (
            <img src={preview} alt="Preview" className="max-h-48 mx-auto rounded-lg mb-3" />
          ) : (
            <Camera className="w-12 h-12 text-white/40 mx-auto mb-3" />
          )}
          <p className="text-white/80 mb-1">Click to upload an image</p>
          <p className="text-white/40 text-sm">JPG, PNG, WEBP (max 10MB)</p>
        </label>